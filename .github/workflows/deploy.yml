# .github/workflows/deploy.yml

name: Deploy Astro Static Site to VPS

on:
  push:
    branches:
      - main # This workflow runs when changes are pushed to the 'main' branch
      - master # This workflow runs when changes are pushed to the 'main' branch

jobs:
  build:
    name: Build Astro Project
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.14.0'

      - name: Install dependencies
        run: yarn install

      - name: Build Astro Project
        run: yarn build
        env:
          NODE_ENV: production
          GH_CLIENT_ID: ${{ secrets.GH_CLIENT_ID }}
          GH_CLIENT_SECRET: ${{ secrets.GH_CLIENT_SECRET }}
          ORIGIN: https://thuongda.dev

      - name: Validate sitemap output
        run: |
          if [ -f dist/client/sitemap-index.xml ]; then
            echo "Found sitemap index: dist/client/sitemap-index.xml"
          elif [ -f dist/client/sitemap.xml ]; then
            echo "Found sitemap: dist/client/sitemap.xml"
          else
            echo "No sitemap generated by Astro. Creating fallback sitemap.xml from content slugs."
            node <<'NODE'
            const fs = require("node:fs");
            const path = require("node:path");

            const baseUrl = "https://thuongda.dev";
            const distClientDir = path.join(process.cwd(), "dist", "client");
            const articlesDir = path.join(process.cwd(), "src", "content", "articles");

            const routes = new Set(["/", "/blog", "/blog/vi", "/projects"]);

            function walk(dir) {
              if (!fs.existsSync(dir)) return [];
              const entries = fs.readdirSync(dir, { withFileTypes: true });
              return entries.flatMap((entry) => {
                const fullPath = path.join(dir, entry.name);
                if (entry.isDirectory()) return walk(fullPath);
                if (entry.isFile() && /\.(md|mdx)$/i.test(entry.name)) return [fullPath];
                return [];
              });
            }

            for (const file of walk(articlesDir)) {
              const content = fs.readFileSync(file, "utf8");
              const frontmatter = content.match(/^---\s*\n([\s\S]*?)\n---/);
              const slugMatch = frontmatter?.[1]?.match(/(?:^|\n)slug:\s*["']?([^\n"']+)["']?/);
              if (slugMatch?.[1]) {
                routes.add(`/blog/vi/${slugMatch[1].trim()}`);
              }
            }

            const now = new Date().toISOString();
            const urls = [...routes]
              .sort()
              .map((route) => {
                const loc = `${baseUrl}${route === "/" ? "" : route}`;
                return `  <url>\n    <loc>${loc}</loc>\n    <lastmod>${now}</lastmod>\n  </url>`;
              })
              .join("\n");

            const xml =
              `<?xml version="1.0" encoding="UTF-8"?>\n` +
              `<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">\n` +
              `${urls}\n` +
              `</urlset>\n`;

            fs.mkdirSync(distClientDir, { recursive: true });
            fs.writeFileSync(path.join(distClientDir, "sitemap.xml"), xml, "utf8");
            console.log(`Generated fallback sitemap with ${routes.size} URLs.`);
            NODE
          fi


      - name: "Debug: List files after build"
        run: |
          echo "Current working directory:"
          pwd
          echo "Files in current directory:"
          ls -la

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: |
            dist/
            package.json
          retention-days: 1

  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist

      - name: Test SSH Connection
        run: |
          echo "Testing connection to ${{ secrets.SSH_HOST }}:${{ secrets.SSH_PORT || 22 }}"
          timeout 10 bash -c "cat < /dev/null > /dev/tcp/${{ secrets.SSH_HOST }}/${{ secrets.SSH_PORT || 22 }}" && echo "Port is open" || echo "Port is closed or unreachable"

      - name: Deploy Node.js app to VPS
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          source: "./dist/*,./package.json"
          target: "/home/${{ secrets.SSH_USERNAME }}/thuongda.dev"
          strip_components: 0
          overwrite: true
      
      - name: Setup Node.js application
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            cd ~/thuongda.dev
            
            echo "=== Creating .env file with OAuth credentials ==="
            cat > .env << EOF
            GH_CLIENT_ID=${{ secrets.GH_CLIENT_ID }}
            GH_CLIENT_SECRET=${{ secrets.GH_CLIENT_SECRET }}
            ORIGIN=https://thuongda.dev
            EOF
            
            echo "=== Creating app.js entry point for cPanel ==="
            cat > app.js << 'APPJS'
            // Load environment variables
            import { config } from 'dotenv';
            config();

            import { createServer } from 'node:http';

            (async () => {
              try {
                const { handler } = await import('./dist/server/entry.mjs');

                const port = process.env.PORT || 4321;
                const host = process.env.HOST || '0.0.0.0';

                const server = createServer(handler);

                server.listen(port, host, () => {
                  console.log(`Astro server started successfully on http://${host}:${port}`);
                });

                // Handle graceful shutdown
                process.on('SIGTERM', () => {
                  console.log('SIGTERM signal received: closing HTTP server');
                  server.close(() => {
                    console.log('HTTP server closed');
                    process.exit(0);
                  });
                });
              } catch (err) {
                console.error('Failed to start Astro server:', err);
                process.exit(1);
              }
            })();
            APPJS
            
            echo "=== Installing production dependencies ==="
            export PATH=$PATH:/opt/cpanel/ea-nodejs22/bin
            npm install --production
            
            # Install dotenv if not already installed
            npm list dotenv || npm install dotenv
            
            echo "=== Deployment completed ==="
            echo "App directory contents:"
            ls -la
            echo ""
            echo "IMPORTANT: Configure your Node.js app in cPanel with:"
            echo "- App Root: /home/\$USER/thuongda.dev"
            echo "- App URL: thuongda.dev (or your domain)"
            echo "- Application Startup File: app.js"
            echo "- Then click 'RESTART' to apply changes"

      - name: Notify search engines about sitemap update
        run: |
          set +e
          curl -fsS "https://www.google.com/ping?sitemap=https://thuongda.dev/sitemap.xml" || true
          curl -fsS "https://www.google.com/ping?sitemap=https://thuongda.dev/sitemap-index.xml" || true

      - name: Post-Deployment Message
        run: echo "Deployment process initiated. Check your VPS for files in public_html."

  notify:
    name: Send Email Notification
    runs-on: ubuntu-latest
    needs: deploy
    if: success()

    steps:
      - name: Send Email Notification
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: thuongda.dev
          server_port: 465
          secure: true
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: ‚úÖ Deployment Successful - thuongda.dev
          to: ${{ secrets.EMAIL_TO }}
          from: GitHub Actions <${{ secrets.EMAIL_USERNAME }}>
          body: |
            üöÄ Deployment Completed Successfully!
            
            Repository: ${{ github.repository }}
            Branch: ${{ github.ref }}
            Commit: ${{ github.sha }}
            Commit Message: ${{ github.event.head_commit.message }}
            Author: ${{ github.actor }}
            
            Workflow: ${{ github.workflow }}
            Run Number: ${{ github.run_number }}
            
            üåê Site: https://thuongda.dev
            
            Timestamp: ${{ github.event.head_commit.timestamp }}
            
            ‚ú® Your site has been deployed and is now live!
