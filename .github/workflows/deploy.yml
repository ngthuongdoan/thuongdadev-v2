# .github/workflows/deploy.yml

name: Deploy Astro Static Site to VPS

on:
  push:
    branches:
      - main # This workflow runs when changes are pushed to the 'main' branch
      - master # This workflow runs when changes are pushed to the 'main' branch

jobs:
  deploy:
    runs-on: ubuntu-latest # Use the latest Ubuntu runner

    steps:
      - name: Checkout code
        uses: actions/checkout@v4 # Action to checkout your repository code

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.14.0' # Specify your Node.js version

      - name: Install dependencies
        run: yarn install

      - name: Build Astro Project
        # This step builds the Astro project to static files in the 'dist' directory
        run: yarn build
        env:
          NODE_ENV: production
      - name: "Debug: List files after build"
        # This step helps verify if the 'dist' directory was created and where.
        run: |
          echo "Current working directory:"
          pwd
          echo "Files in current directory:"
          ls -la

      - name: Test SSH Connection
        run: |
          echo "Testing connection to ${{ secrets.SSH_HOST }}:${{ secrets.SSH_PORT || 22 }}"
          timeout 10 bash -c "cat < /dev/null > /dev/tcp/${{ secrets.SSH_HOST }}/${{ secrets.SSH_PORT || 22 }}" && echo "Port is open" || echo "Port is closed or unreachable"

      - name: Restore backup immediately (emergency recovery)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            echo "=== EMERGENCY: Restoring from backup ==="
            if [ -d ~/backup ]; then
              cp -r ~/backup/* ~/public_html/ 2>/dev/null || true
              echo "Backup restored to keep site online"
            fi
            ls -la ~/public_html/
      
      - name: Deploy Astro server app to VPS
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          source: "./dist/*,./package.json"
          target: "/home/${{ secrets.SSH_USERNAME }}/thuongda.dev"
          strip_components: 0
          overwrite: true
      
      - name: Setup Node.js app on VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            cd ~/thuongda.dev
            echo "=== Creating app.js entry point ==="
            cat > app.js << 'EOF'
            // Start the Astro standalone server
            import('./dist/server/entry.mjs')
              .then(module => {
                console.log('Astro server started successfully');
              })
              .catch(err => {
                console.error('Failed to start Astro server:', err);
                process.exit(1);
              });
            EOF
            
            echo "=== App files deployed ==="
            ls -la dist/
            echo "App ready to start"
      
      - name: Verify deployment and fix permissions
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            echo "=== Verifying deployment ==="
            echo "Contents of ~/public_html:"
            ls -lah ~/public_html/
            echo ""
            echo "Checking for index.html:"
            if [ -f ~/public_html/index.html ]; then
              echo "✓ index.html found"
              echo "Last modified: $(stat -c '%y' ~/public_html/index.html 2>/dev/null || stat -f '%Sm' ~/public_html/index.html)"
              echo "First 3 lines of index.html:"
              head -n 3 ~/public_html/index.html
            else
              echo "✗ index.html NOT found!"
            fi
            echo ""
            echo "Setting correct permissions..."
            chmod -R 755 ~/public_html
            echo "Permissions updated."
      
      - name: Copy backup folder to preserve old routes
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            if [ -d ~/backup ]; then
              echo "Copying backup folder to public_html to preserve old routes..."
              cp -r ~/backup/* ~/public_html/ 2>/dev/null || echo "No files to copy from backup or some files already exist"
              echo "Backup copy completed."
            else
              echo "Warning: ~/backup directory not found. Skipping backup copy."
            fi
            echo ""
            echo "=== Final directory structure ==="
            ls -lah ~/public_html/

      - name: Post-Deployment Message
        # This step runs on the GitHub Actions runner after the SSH action completes.
        run: echo "Deployment process initiated. Check your VPS for files in public_html."

